---
title: "Introducing stplanr"
author: "Robin Lovelace"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introducing stplanr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
---

```{r, include=FALSE}
library(stplanr)
library(sp) # needed for geographical objects
library(leaflet) # needed for plotting data
```

## Abstract

Tools for transport planning should be flexible, robust, and able to handle a wide variety of geographical and transport survey datasets out-of-the-box. In democracies, they should also be transparent and accessible. **stplanr** meets each of these criteria by providing functionality commonly needed for transport planning in R. This includes the creation of geographic 'desire lines' from origin-destination data; tools to automate the import of road traffic casualty datasets; interface to routing services (including CycleStreets.net, Graphhopper and OSRM); 'travel watershed' analyis and; access to Google's Travel Matrix API. This paper demonstrates **stplanr** can be used to design sustainable transport systems, using a case study of how to allocate funding to maximise cycling uptake in the city of Leeds, UK. We conclude that open source tools such as **stplanr**, used in conjunction with open datasets and public debate, can enable transport plans to be based on the best available evidence, as part of a global transition away from fossil fuels.

## Introduction

As settlements worldwide have grown and become more complex, the process of planning has had to adapt. Planners today are specialists, in sub-fields such as Emergency, Logistics, Healthcare, Urban and Transport Planning. And the 'art' of planning has become more of a science, with its own array of specialist hardware and software.

The process of Transport Planning has undergone a particularly dramatic revolution. Transport interventions such as new bridges, ports and active travel routes are no longer decided based on the intuition of public sector or political authorities. Decisions are now the result of a long socio-technical process involving public consultation, cost-benefit analyses and computer modelling and visualisation. With the ongoing digital revolution, the importance of this last stage has grown, to the point where transport planning is now a highly technical process, employing dozens of software developers in large planning organisations. There is now a multi-billion pound global transport planning consultancy industry, to support the decision-making process. Yet the fruits of all this labour are unavailable to the vast majority of citizens worldwide, and transport planning decisions which go against the best available evidence keep getting made.

This is the evolving context which motivated the development of **stplanr**. Its aim is simple: to provide an accessible toolbox of for transport planning. It is hoped that it will be useful for practitioners and researcher alike as part of the transition to open source software taking place in the tech industry, which is gradually filtering down into other sectors of the economy, notably 'Big Data' in
consultancy.^[Comments
in support of this statement were made by a MKinsey manager during the European R Users Meeting (eRum), Poznan, 2016.
]
The best available evidence suggests that the future of civilisation depends on our ability to transition away from fossile fuels. The transport sector is the fastest growing source of emissions by sector and represents a major roadblock in the path towards a zero-carbon economy. Transport systems are a major cause of ill health, by enabling sedentary lifestyles and causing numerous road traffic casualties. Knowledge of these impacts motivated the word 'sustainable' in the package's name: by focussing on active travel and public transport modes, **stplanr** encourages the design of transport interventions that reduce dependence on fossil fuels. 

To plan for any transport intervention, sustainable or otherwise, common computational tasks that need to be undertaken include:

- Accessing and processing of data on transport infrastructure and behaviour
- Analysis and visualisation of the transport network
- Analysis of origin-destination (OD) data and the visualisation of resulting 'desire lines'
- The allocation of desire lines to roads and other guideways via routing algorithms to show commonly used routes through geographical space
- The aggregation of routes to estimate total levels of flow on segments throughout the transport network
- Development of models to estimate transport behaviour currently and under various scenarios of change
- The calculation of 'catchment areas' affected by transport infrastructure

The automation of such tasks can assist researchers and practitioners create evidence for decision making. If the analysis stage is fast and painless, this will allow more time for visualisation and decision making, allowing transport planners to focus on transport problems, rather than wrestling with software to load and understand their data. Thus **stplanr** fits into the fist parts of a wider analyse, plan, design workflow.

**stplanr** facilitates each of these tasks with a series of functions which, used in conjunction with R's statistical and (via packages such as **raster**) spatial capabilities, provide an integrated toolkit for computational transport planning research. Because R has a command-line interface (CLI), as opposed to the graphical user interface (GUI) approach used in many transport planning programs, it has a steep learning curve. This issue is tackled by documentation: **stplanr** has numerous example datasets (outlined in the next section), descriptive help pages (e.g see `?od2line` and `example(od2line)`) and a vignette (on which this paper is based). 

The advantage of using scriptable languages such as R are manifold: it enables automation, for example the application of an analysis workflow developed for one city to be applied to another; it facilitates the analysis to be combined with other software, e.g. to sit within a GUI-based GIS such as QGIS or on a public-facing web-server via **shiny**; and it makes the results of transport planning research reproducible. This final advantage is critical in an age of planning decisions based on increasingly abundant data and supposedly community-led processes: reliance on 'black box' models [@waddell_urbansim:_2002] makes software a weak link in the democratisation of transport planning decisions [@hollander_who_2015] often the the same applies to scientific research into transport systems.

**stplanr** seeks to address these issues. After the package
has been installed (see the package's
[README](https://github.com/Robinlovelace/stplanr) for details),
it can be loaded in with `library()`:

```{r, message=FALSE}
library(stplanr)
```

## Accessing and converting data

Transport data is often provided in origin-destination ('OD')
form, either as a matrix or (more commonly) a long table
of OD pairs. An example of this type of raw data is provided
below (see `?flow` to see how this dataset was created).  

```{r}
data("flow", package = "stplanr")
head(flow[c(1:3, 12)])
```

Although the flow data displayed above describes movement over
geographical space, it contains no explicitly geographical
information. Instead, the coordinates of the origins and
destinations are linked to a separate geographical dataset
which also must be loaded to analyse the flows. This is a
common problem solved by the function `od2line`.
The geographical data is a set of points representing centroids
of the origin and destinations, saved as a
`SpatialPointsDataFrame`. Geographical data in R is best
represented as such `Spatial*` objects, which use the
`S4` object engine. This explains the close integration of
**stplanr** with R's spatial packages, especially **sp**, which
defines the `S4` spatial object system.

```{r}
data("cents", package = "stplanr")
as.data.frame(cents[1:3,-c(3,4)])
```

We use `od2line` to combine `flow` and `cents`, to join
the former to the latter. We will visualise the
`l` object created below in the next section. 

```{r}
l <- od2line(flow = flow, zones = cents)

# remove lines with no length
l <- l[!l$Area.of.residence == l$Area.of.workplace,]
```

The data is now in a form that is much easier to analyse. We can plot the
data with the command `plot(l)`, which was not possible before. Because the
`SpatialLinesDataFrame` object also contains data per line, it also helps
with visualisation of the flows, as illustrated below.

```{r}
plot(l, lwd = l$All / 10)
```

## Allocating flows to the transport network

A common problem faced by transport researchers is network
allocation: converting the 'as the crow flies' lines illustrated in the
figure above into routes. These are the complex, winding
paths that people and
animals make to avoid obstacles such as buildings and to make the journey
faster and more efficient (e.g. by following the road network).

This is difficult (and was until recently near impossible using free software)
because of the size and complexity of transport networks, the complexity
of realistic routing algorithms and need for context-specificity in the routing
engine. Inexperienced cyclists, for example, would take a very different route
than a heavy goods vehicle.

**stplanr** tackles this issue by using 3rd party APIs to provide
route-allocation.

### CycleStreets.net

The `line2route` function allocates straight line
routes to the transport network using the
[CycleStreets.net API](http://www.cyclestreets.net/api/) (you must request
an API key for the function to work):

```{r, eval=FALSE}
routes_fast = line2route(l = l, route_fun = route_cyclestreet)
```


```{r}
plot(l)
lines(routes_fast, col = "red")
```

The above code sends requests to CycleStreets.net and saves the results.
By changing the `plan` argument of `line2route`, we can download
routes that are more suitable for people prioritising speed, quietness or
a balance between speed and quietness. The plots of `l` and `routes_fast` illustrate
how the spatial classes that the flow data are converted to are easy to
visualise. It is recommended that the output datasets created by **stplanr** are vizualised by packages for spatial data visualisation [e.g. see @cheshire_spatial_2015;@kahle_ggmap:_2013] to increase their impact.

### Graphhopper

`route_graphhopper()` extracts geographical and other data from the graphhopper
routing engine to allocate flows to the travel network.

```{r, eval=FALSE}
# not shown
ny2oaxaca1 <- route_graphhopper("New York", "Oaxaca", vehicle = "bike")
ny2oaxaca2 <- route_graphhopper("New York", "Oaxaca", vehicle = "car")
plot(ny2oaxaca1)
plot(ny2oaxaca2, add = T, col = "red")

ny2oaxaca1@data
ny2oaxaca2@data
```

Note that the function also saves time, distance and (for bike trips)
vertical distance climbed for the trips.

## Analysis of origin-destination flow data

Route-allocated lines allow estimation of *route distance* and 
*cirquity* (route distance divided by Euclidean distance).
These variables can help model the rate of flow between origins and
destination, as illustrated in the next section. The code below demonstrates
how objects generated by **stplanr** can be used to estimate route distance.

```{r}
lgb <- spTransform(l, CRSobj = CRS("+init=epsg:27700"))
l$d_euclidean <- rgeos::gLength(lgb, byid = T)
l$d_fastroute <- routes_fast@data$length
plot(l$d_euclidean, l$d_fastroute,
  xlab = "Euclidean distance", ylab = "Route distance")
abline(a = 0, b = 1)
abline(a = 0, b = 1.2, col = "green")
abline(a = 0, b = 1.5, col = "red")
```

The plot illustrates the expected strong correlation between
Euclidean and fastest route distance. However, some OD pairs
have a proportionally higher route distance than others.
This is illustrated
by distance from the black line in the above plot, which represents circuity. 

To estimate the amount of capacity needed at each segment on the transport
network, the `overline` function, written by Barry Rowlingson can be used. This
divides up line geometries into unique segments then aggregates the overlapping
values. The results, plotted on the map, can be used to estimate where there is
most need to improve the transport network, for example informing the decision of
where to build new bicycle paths.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
routes_fast$All <- l$All
rnet <- overline(routes_fast, "All", fun = sum)
rnet$flow <- rnet$All / mean(rnet$All) * 3
plot(rnet, lwd = rnet$flow / mean(rnet$flow))
```


## Developing models of travel behaviour

There are many ways of estimating flows between origins and destinations,
including spatial interaction models, the four-stage transport model
and 'distance decay'. **stplanr** aims eventually to facilitate
creation of many types of flow model. 

At present (May 2015) the only functions to assist with this are
the `dd_*` functions, simple commands to create distance decay curves.
Distance decay is an especially important concept for sustainable transport
planning due to physical limitations on the ability of people to walk and
cycle large distances [@iacono_measuring_2010].

Let's explore the relationship between distance and the proportion of trips
made by walking, using the same object `l` generated by **stplanr**.

```{r}
l$pwalk <- l$On.foot / l$All
plot(l$d_euclidean, l$pwalk, cex = l$All / 50,
  xlab = "Euclidean distance (m)", ylab = "Proportion of trips by foot")
```

Based on the figure there is a clear negative relationship
between distance of trips and the proportion of those trips made by walking.
This is unsurprising: beyond a certain distance (around 1.5km according
the the data presented in the figure above) walking may a rather slow and
and many people would concider travelling by bike instead!
According to the academic literature, this 'distance decay' is non-linear
and there have been a number of functions proposed to fit to distance decay
curves [@martinez_new_2013]. From the range of options we test below just two forms.
We will compare the ability of linear and log-square-root functions
to fit the data contained in `l` for walking.

```{r}
lm1 <- lm(pwalk ~ d_euclidean, data = l@data, weights = All)
lm2 <- lm(pwalk ~ d_fastroute, data = l@data, weights = All)
lm3 <- glm(pwalk ~ d_fastroute + I(d_fastroute^0.5), data = l@data, weights = All, family = quasipoisson(link = "log"))
```

The results of these regression models can be seen using `summary()`.
The results for such a small dataset are not particularly interesting and,
surprisingly, Euclidean distance seems to be a better predictor of
walking that route distance. The results are displayed in the graphic below.

```{r, echo=FALSE, eval=FALSE}
summary(lm1)
summary(lm2)
summary(lm3)
```


```{r}
plot(l$d_euclidean, l$pwalk, cex = l$All / 50,
  xlab = "Euclidean distance (m)", ylab = "Proportion of trips by foot")
l2 <- data.frame(d_euclidean = 1:5000, d_fastroute = 1:5000)
lm1p <- predict(lm1, l2)
lm2p <- predict(lm2, l2)
lm3p <- predict(lm3, l2)
lines(l2$d_euclidean, lm1p)
lines(l2$d_euclidean, exp(lm2p), col = "green")
lines(l2$d_euclidean, exp(lm3p), col = "red")
```

## Future plans

The final thing to say about this package is that it is work-in-progress
and we hope to add more functionality, including tools for creating
spatial interaction models, more functions to access routing APIs and
improved functionality for accessing OpenStreetMap data.

If you would like to contribute or request new features, see
https://github.com/Robinlovelace/stplanr

## References

