---
title: "stplanr"
output:
  html_document:
    keep_md: yes
---

[![Build Status](https://travis-ci.org/Robinlovelace/stplanr.svg?branch=master)](https://travis-ci.org/Robinlovelace/stplanr) [![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/stplanr)](http://cran.r-project.org/web/packages/stplanr)

```{r, echo=FALSE}
library(stplanr)
```

This is a package for sustainable transport planning in R (stplanr).

It brings together a range of tools for transport planning practitioners and
researchers to better understand transport systems and inform policy.

The initial work on the project was funded by the Department of Transport
([DfT](https://www.gov.uk/government/organisations/department-for-transport))
as part of the National Propensity to Cycle Tool
([NPCT](http://www.cedar.iph.cam.ac.uk/research/modelling/npct-tool/)) project to
identify where bicycle paths are most urgently needed.

## Key functions

Square data frames representing flows between origins and destinations
must be combined with geo-referenced zones or points to generate meaningful
analyses and visualisations of flows. **stplanr** facilitates this with 
`od2line()`, which takes flow and geographical data as inputs and
outputs a `SpatialLinesDataFrame`. Some example data is provided in the package:

```{r, results='hide', message=FALSE}
library(stplanr)
data(cents, flow)
```

Let's take a look at this data:

```{r}
flow[1:3, 1:3] # typical form of flow data
cents[1:3,] # points representing origins and destinations
```

These datasets can be combined as follows:

```{r plot1}
travel_network <- od2line(flow = flow, zones = cents)
w <- flow$All / max(flow$All) *10
plot(travel_network, lwd = w)
```

The package can also allocate flows to the road network, for example through
a link to the [CycleStreets.net API](https://www.cyclestreets.net/api/):

```{r cycle-trip, message=FALSE, results='hide'}
trip <- route_cyclestreet(from = c(-1, 53), to = c(-1.1, 53), plan = "balanced")
# devtools::install_github("mtennekes/tmap", subdir = "pkg")
library(tmap)
osm_tiles <- read_osm(bbox(trip))
tm_shape(osm_tiles) +
  tm_raster() +
  tm_shape(trip) +
  tm_lines(lwd = 3)
```

We can replicate this call to CycleStreets.net multiple times
using `line2route`.

```{r plot2, results='hide', message=FALSE}
# Remove intra-zone flow
intrazone <- travel_network$Area.of.residence == travel_network$Area.of.workplace
travel_network <- travel_network[!intrazone,]
routes <- line2route(travel_network)
plot(routes)
```

For more examples, `example("line2route")`.

`gOverline` is a function which takes a series of route-allocated lines,
splits them into unique segmentes and aggregates
the values of overlapping lines. This can represent where there will be
most traffic on the transport system, as illustrated below.

```{r rnet}
routes$All <- travel_network$All
rnet <- gOverline(sldf = routes, attrib = "All", fun = sum)
plot(rnet, lwd = rnet$All / mean(rnet$All))
points(cents, col = "red", pch = 18)
```

## Installation

```{r, eval=FALSE}
# you must have the devtools package (e.g. via install.packages("devtools"))
devtools::install_github("robinlovelace/stplanr")
library(stplanr)
```

stplanr depends on rgdal, which can be difficult to installon Mac and Linux
users. 

### Installing rgdal on Ubuntu and Mac

On Ubuntu rgdal can be installed with:

```
sudo apt-get install r-cran-rgdal
```

Using apt-get ensures the system dependencies, such as
[gdal](http://trac.osgeo.org/gdal/wiki/DownloadingGdalBinaries) are also installed.

On Mac, homebrew can install gdal. Full instructions are provided
[here](https://github.com/ropensci/geojsonio#install).


## Funtions, help and contributing

The current list of available functions can be seen with:

```{r}
lsf.str("package:stplanr", all = TRUE)
```

To get internal help on a specific function, use the standard way.

```{r, eval=FALSE}
?od2line
```

This project is released with a [Contributor Code of Conduct](CONDUCT.md).
By participating in this project you agree to abide by its terms.

Please report issues, feature requests and questions to the
[github issue tracker](https://github.com/robinlovelace/stplanr/issues).


